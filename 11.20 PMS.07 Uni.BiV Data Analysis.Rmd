---
title: "1120 Data Analysis"
author: "Michelle K Jamieson"
date: "25/08/2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
    theme: flatly
    highlight: textmate

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction to the Data



```{r libraries}
# load libraries 
pacman::p_load(gmodels, 
               skimr, 
               knitr, 
               tidyverse, 
               haven, 
               psych,
               dplyr,
               synthpop,
               dataMaid,
               Hmisc,
               ggplot2)
```

## Reading in .CSV Data into R

The ```haven``` package can import datasets created by SPSS and a number other programs such as Stata and SAS.

There are a few features of SPSS datasets that require special handling when loading data into R. SPSS files often contain variables with both character labels and numeric codes that are not necessarily sequential (e.g. for the variable 'ever been in paid employment', 1 = item not applicable, 2 = yes, 3 = no, 4 = don't know, 5 = no answer/refused). SPSS also allows variables to have multiple, user-defined missing values. This sort of variable metadata is helpful, but it doesn’t quite align with any of R’s standard data types.

The ```haven``` package handles these differences by importing variables in a custom format called ```labelled``` and leaving the user to decide which of the numeric codes or value labels he or she wants to work with in R.

We’ll import the data using ```haven’s``` ```read_sav()``` function. We'll set ```user_na = TRUE``` to ensure that responses such as "Don't know" or "Refused" aren’t automatically converted to missing values. In this case, we also want to convert any labelled variables into factors so that we can work with value labels instead of the numeric codes (e.g. "yes" instead of "1"). We do this by piping ```(%>%)``` the entire dataset to ```haven's``` ```as_factor()``` function which converts any labelled variables in the dataset to factors.

```{r read in}
source_pms07 <- haven::read_sav("pms07.sav", 
                  user_na = TRUE) %>%
  as_factor()
```

## Subsetting the data

All original variables within the 2007 PMS we're interested in.  

```{r subset}
# Subsetting to manage descriptive, work, 
# and health variables
subset_pms07 <- source_pms07 %>% 
  dplyr::select("pserial","ResSex","Health6","Language","Age10yr","Age20yr",
                "ETHNIC4",
                "Origin","EDQUAL5","AnyQuals","HiQuals","ResMarDF",
                "DVILO3a","DVPrac","Care1","Care2","Care3","Care4",
                "Care5","Everwk","yearjbl","JbReas","Looked",
                "YInAct","LookStop","LookSto2","Stat","Solo",
                "HrsWeek","PTWkHour","EmpStY","LookNot1","LookNot2",
                "LookNot3","DVLastWk","NotWk","WkShel1","HrsWork",
                "LookSto3","DiffJob","WkShel2","WkShel3","SEmpStY",
                "LookNow","LookAtAl","JobstM","EmpNo","Manage",
                "FtPtWk","NotWk","SEG","SC","SrcInc1","SrcInc2",
                "SrcInc3","SrcInc4","SrcInc5","SrcInc6","Gross4",
                "Gross4a","Ten1","LLord","SF6","SF7","SF9","SF11",
                "SF12","CONHOMD","IMon","FollUpGrp",
                "eligible","Stage2","Origin","DVPrac","Care1","Care2",
                "Care3","Care4","Care5","Medic","CnslHav","CnslTak",
                "CnslLng","DocYear","DocPsyc","PMatNum","DocTalk",
                "DocWeeks","InWhy","OutWhy","DayY","DayWht1",
                "DayWht2","DayWht3","DayWht4","CC2aY",
                "CC2Y1","CC2Y2","CC2Y3","CC2Y5","CC2Y6","CC2Y7",
                "CC2Y8","CC2Y9","MentHos","Ten1","Gross4a","qimd",
                "gor06","newsha","SF1","Happy","tenure","newten",
                "hhdtype","DISsex","DISeth","DISrel","DISAge",
                "DISmen","DISphy",
                "DISsori","CISRFOUR","panic","GAD","madd","OCD",
                "phob","dep","neurotic","nosymp","numdis",
                "PTSDever","MajorT16","PTSDcom","PTSDPos",
                "suicthwk","suicthyr","suicthlf","DSHlife",
                "suicatwk","suicatyr","suicatlf","DSHtry","suihfri",
                "suihhos","suihcom","suihhel","suihoth","DSH5",
                "DSHharm","DSH9","DSH10","PsycProb","Psycdis",
                "Psycdis_wt","BPDPH2","bdpd_wt","ASPDPH2","aspd_wt",
                "DVADHD1","DVADHD2","DVADHD4","scoff2","EDImpact",
                "bmigp4","DVAudit1","AUDITgp","DRNKPROB","SADQCSC",
                "SADQGP","AUDSAD2","Cannever","Cannyear","AMPHEVER",
                "AMPHYEAR","COCAEVER","CRACEVER","CRACYEAR",
                "ECSTEVER","ECSTYEAR","HEROEVER","HEROYEAR",
                "ACIDEVER","ACIDYEAR","MUSHEVER","MUSHYEAR",
                "METHEVER","METHYEAR","TRANEVER","TRANYEAR",
                "AMYLEVER","AMYLYEAR","ANABEVER",
                "ANABYEAR","GLUEEVER","GLUEYEAR","DRUGEVER",
                "DRUGYEAR","DRUGDEP",
                "DRUGDEP2","GamYR","dsmscgr","dsmprob","dsmpath",
                "numdiag","numdiag4","LCA","cluster1","cluster2",
                "cluster3","cluster4","cluster5","cluster6",
                "MedPsyc","MedDep","MedHyp","MedAnx","MedADHD",
                "anymed","Doc2Wks","DocPsyc","INQTRMEN","OUTQTRME",
                "PSYCTHER","COGTHER","ARTTHER","SOCTRAIN","MARITHER"
                ,"SEXTHER","COUNSEL","OTHTHER","OTHTHER","anyther",
                "trtment","DAYCOMYR","PSYTRTYR","PSYLGTYR",
                "CPNYR","CLDNYR","OTHNSEYR","SOCWRKYR","CPNYR",
                "ERI3","SFQA","SFQB","SFQC","SFQD",
                "SFQE","SFQF","SFQG","SFQH","DLSS4","DLSS5",
                "PrimGrp","ChldInst","LACare","BothMaPa",
                "YNotBoth","MaOrPa","AnyChild","NoChild",
                "InDebt1","InDebt6",
                "SFHELPYR","HMHELPYR","OREACHYR","anyccar","anyhlca"
                ,"anydaca","wt_ints1","ipsu_0714","istrata_0714")

head(subset_pms07, 5)
```

## Viewing the Data 

A nice way to view the subsetted dataset.

```{r view}
# view 
#subset_pms07 %>% sjPlot::view_df()# no longer needed
# makeCodebook now works after reading in 
# .csv with as.factor()
#makeCodebook(subset_pms07, vol = "10",
#             reportTitle = NULL, file = NULL)

glimpse(subset_pms07)
```

# Understanding the Subset

Getting to grips with what's in the variables will help decide on meaningful analysis later on. 
```{r}

subset_pms07 %>%
  distinct(ResSex)
subset_pms07 %>%
  distinct(Age10yr)
subset_pms07 %>%
  distinct(SF1)
subset_pms07 %>%
  distinct(Happy)
subset_pms07 %>%
  distinct(Everwk)
subset_pms07 %>%
  distinct(Psycdis)

```

# Cleaning Subset

## Re-Coding Names

Making the variables easier to understand.

```{r variable names}
# look at variable names 
colnames(subset_pms07)

# rename variables for easier reading 
subset_pms07 <- subset_pms07 %>% 
  rename(GenHeal = SF1,
         Paidwk = Everwk,
         DefPsych = Psycdis,
         Sex = ResSex,
         EthnicGrp = ETHNIC4,
         HiEduQualGrp = EDQUAL5,
         MariStat = ResMarDF, 
         EmpStatGrp = DVILO3a, 
         DaLivHelp = DVPrac, 
         LeftJob = yearjbl,
         JobReas = JbReas,
         LookWk4 = Looked,
         NotLookWk = YInAct,
         Working = Stat,
         WkSolo = Solo,
         TimeLWk = DVLastWk,
         NotWkRea = NotWk,
         SocEcGrp = SEG,
         SocCl = SC,
         LessWkEmo = SF6,
         LessCarEmo = SF7,
         FelCal = SF9,
         FelDownH = SF11,
         ProbInter = SF12,
         PosEx = CONHOMD,
         CurMeds = Medic,
         ComCaYr = CC2aY,
         ComCaPsychi = CC2Y1,
         CommCaPsychol = CC2Y2,
         ComCarCPN = CC2Y3,
         ComCarON = CC2Y5,
         ComCarSW = CC2Y6,
         ComCaSHGrp = CC2Y7,
         ComCaHH = CC2Y8,
         ComCaOW = CC2Y9,
         GenHeal = SF1
         )

# check it worked 
colnames(subset_pms07)
```


# Descriptive Statistics 

## Overall Age, Sex, General Employment and Mental Health
There are 7,403 respondants within the PMS 2007 dataset. 

```{r}
skim(subset_pms07$pserial)

(as.data.frame(table(subset_pms07$Age10yr)) 
  %>% rename(Count=1,Freq=2) %>% mutate(Perc=100*Freq/sum(Freq)))
(as.data.frame(table(subset_pms07$Sex)) 
  %>% rename(Count=1,Freq=2) %>% mutate(Perc=100*Freq/sum(Freq)))
(as.data.frame(table(subset_pms07$Paidwk)) 
  %>% rename(Count=1,Freq=2) %>% mutate(Perc=100*Freq/sum(Freq)))
(as.data.frame(table(subset_pms07$Health6)) 
  %>% rename(Count=1,Freq=2) %>% mutate(Perc=100*Freq/sum(Freq)))
```


## Non-Severe Mental Illness
The term NSMI refers to a set of illness’ that are much more common in the general population, and include, depression (including subthreshold disorders) and, anxiety disorders (including GAD, panic disorder, phobias, social anxiety disorder, OCD and PTSD) (NICE, 2019)

## Respondant Sex Variable 

So this table tells us that 43.1% and 56.8% of the sample are male and female respectively, which sounds pretty reasonable.

```{r descriptive}

# prop 
prop.table(table(subset_pms07$Sex))

```

## Age Respondant Variable 

The next step is to see if any age groups are over or under-represented in either of the genders. I’m going to use the package gmodels to produce these cross-tables:

```{r age descriptive}
CrossTable(subset_pms07$Age10yr,
          subset_pms07$Sex,prop.r=FALSE,prop.t=FALSE,
          prop.chisq=FALSE)
```
## General Employment
```{r genempl}
# by age
CrossTable(subset_pms07$Paidwk,
          subset_pms07$Age20yr,prop.r=FALSE,prop.t=FALSE,
          prop.chisq=FALSE)

# by sex 
CrossTable(subset_pms07$Paidwk,
          subset_pms07$Sex,prop.r=FALSE,prop.t=FALSE,
          prop.chisq=FALSE)


# by reported mh cond
CrossTable(subset_pms07$Paidwk,
          subset_pms07$Health6,prop.r=FALSE,prop.t=FALSE,
          prop.chisq=FALSE)
```


## Mental Health Variable

Exploring the presence of poor mental health across genders, you would expect to see higher reporting in women, but a higher portion of psychosis diagnosed in men. 

From this we can see that more females (17, .04%) than males (6, .02%) reported an episode of psychosis in the past year.

```{r men hea ex}
CrossTable(subset_pms07$Health6,
           subset_pms07$Sex,prop.r=FALSE,prop.t=FALSE,
           prop.chisq=FALSE)

CrossTable(subset_pms07$DefPsych,
           subset_pms07$Sex,prop.r=FALSE,prop.t=FALSE,
           prop.chisq=FALSE)

```

## Employment 

From this we can see of those who had a paid job (39.9%), 23.1% mentioned a mental health condition.

We can see more females (47) than males (5) in a paid job mentioned having a mental health condition. More females who were not in a paid job (539) also mentioned having a mental health condition than men (236).

```{r empl disc}
prop.table(table(subset_pms07$Paidwk))
prop.table(table(subset_pms07$Health6))


# bar chart 
ggplot(subset_pms07,aes(x=Paidwk))+
  geom_bar()+
  facet_grid(~Health6)

# 2-Way Cross Tabulation
CrossTable(subset_pms07$Sex, subset_pms07$Health6)

# 3-Way Frequency Table
# gender by ever having a paid job and mentioned 
# having a mental health condition 
mytable <- table(subset_pms07$Sex, subset_pms07$Paidwk,
                 subset_pms07$Health6)
ftable(mytable)
```

# Severe Mental Illness
The term SMI refers to three categories of mental illness, each containing several diagnoses’, including schizophrenia, psychosis, and personality disorders. They are identified by the International Classification of Disease codes F20 through to F39 (ICD-10, 2018). For the purpose of this research, SMI will also include ‘treatment resistant’ conditions – which are usually by that point chronic and so believed to constitute SMI (Iasevoli et al., 2016). Also, of note is the exclusion (where it can be identified) of SMI when comorbid with learning disabilities, as this poses a different set of challenges 

# Visulisation 

# Non-Severe Mental Illness

# Severe Mental Illness
## Age 

The largest group is males in the 40 - 50 age group.

```{r age vis}
#ggplot(subset_pms07,aes(x=Agegroup))+
#  geom_bar()+
#  facet_grid(~Sex)
```

## Mental Health
```{r men hea}
ggplot(subset_pms07,aes(x=Health6))+
  geom_bar()+
  facet_grid(~Sex)


# visualisation
ggplot(subset_pms07,aes(x=DefPsych))+
  geom_bar()+
  facet_grid(~Sex)
```

## Employment 

```{r empl vis}
# bar chart 
ggplot(subset_pms07,aes(x=Paidwk))+
  geom_bar()+
  facet_grid(~Health6)


```

# Tests of Independance 

E.g. Test the null hypothesis whether the respondants paid job status is independent of their psychosis diagnosis at .05 significant level. 

## Chi-Sqaure 

```{r chi}
# significance level.
chisq.test(subset_pms07$Paidwk, subset_pms07$DefPsych)
```

As the p-value 9.099 (#why has this changed from 1.263 from last time?) is greater than the .05 significance level, we do not reject the null hypothesis that the respondants paid job status is independent of their psychosis diagnosis.

## Correlations

```{r corrs}

```

## T-Tests

```{r tt}

```

## Futher Analysis 

```{r regs}

```

## LCA

```{r LCA}

```


# Codebook

```{r cb}
makeCodebook(subset_pms07, vol = "9", 
             reportTitle = NULL, file = NULL)
```

